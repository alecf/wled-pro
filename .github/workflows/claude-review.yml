name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v44
      with:
        files: |
          **/*.ts
          **/*.tsx
          **/*.js
          **/*.jsx

    - name: Claude Code Review
      if: steps.changed-files.outputs.any_changed == 'true'
      uses: actions/github-script@v7
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      with:
        script: |
          const fs = require('fs');
          const path = require('path');

          // Get the list of changed files
          const changedFiles = process.env.CHANGED_FILES.split(' ');

          // Read file contents
          const fileContents = {};
          for (const file of changedFiles) {
            if (fs.existsSync(file)) {
              fileContents[file] = fs.readFileSync(file, 'utf8');
            }
          }

          // Get the diff
          const { data: diff } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number,
            mediaType: {
              format: 'diff'
            }
          });

          // Prepare the prompt for Claude
          const prompt = `You are a senior software engineer reviewing a pull request for a React/TypeScript project called WLED Pro.

          Project context:
          - Built with React 19 + TypeScript + Vite
          - Uses TanStack React Query for state management
          - Tailwind CSS v4 + shadcn/ui for styling
          - Vitest + Testing Library for testing

          Please review the following changes and provide:
          1. Code quality assessment
          2. Potential bugs or issues
          3. Security concerns
          4. Performance considerations
          5. Best practice suggestions
          6. TypeScript/React-specific improvements

          Be constructive and specific. Focus on meaningful issues, not nitpicks.

          Changed files:
          ${changedFiles.join(', ')}

          Diff:
          \`\`\`diff
          ${diff}
          \`\`\`

          Provide your review in markdown format.`;

          // Call Claude API
          const response = await fetch('https://api.anthropic.com/v1/messages', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': process.env.ANTHROPIC_API_KEY,
              'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 4096,
              messages: [{
                role: 'user',
                content: prompt
              }]
            })
          });

          if (!response.ok) {
            throw new Error(`Claude API error: ${response.status} ${response.statusText}`);
          }

          const result = await response.json();
          const review = result.content[0].text;

          // Post the review as a comment
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `## ðŸ¤– Claude Code Review\n\n${review}\n\n---\n*Automated review by Claude Sonnet 4*`
          });
      env:
        CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
